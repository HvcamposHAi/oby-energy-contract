<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OBY Energy - Painel Administrativo</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script> 
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/docx@7.8.2/build/index.js"></script>
    <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Configura√ß√µes do Supabase
        const SUPABASE_URL = 'https://uuaqmwnfjopgjmjjchmw.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1YXFtd25mam9wZ2ptampjaG13Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1OTEyNzUsImV4cCI6MjA3NjE2NzI3NX0.9ITSBR9SNoZKgvF1AuW4OsL4b8Du5NAXttQpi7B3MO8';

        // Credenciais de Admin
        const ADMIN_USER = 'admin';
        const ADMIN_PASS = 'oby2025';

        // --- COMPONENTE: RELAT√ìRIO FINANCEIRO ---
        function FinancialReport({ propostas }) {
            
            const propostasAprovadas = propostas.filter(p => p.status === 'aprovado' && p.simulacao_economia_mensal > 0);

            const formatarMoeda = (valor) => {
                const num = parseFloat(valor); 
                if (isNaN(num)) return 'R$ 0,00';
                return num.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            };

            const exportarParaCSV = () => {
                const cabecalho = [
                    "N¬∫ Contrato", "Vendedor", "Cliente", "Email", "Cidade", 
                    "Consumo (kWh)", "Custo Atual (R$)", "Custo OBY (R$)", 
                    "Desconto Aplicado (%)", "Economia Mensal (R$)", "Status"
                ];

                const linhas = propostasAprovadas.map(p => {
                    const nomeCliente = p.nome && p.sobrenome ? `${p.nome} ${p.sobrenome}` : p.nome_fantasia || 'Sem nome';
                    return [
                        `"${p.numero_contrato || 'N/A'}"`,
                        `"${p.vendedor || 'Sem Vendedor'}"`,
                        `"${nomeCliente}"`,
                        `"${p.email || ''}"`,
                        `"${p.cidade || ''}"`,
                        `"${p.consumo_kwh || 0}"`,
                        `"${formatarMoeda(p.simulacao_conta_atual).replace('R$', '').trim()}"`,
                        `"${formatarMoeda(p.simulacao_conta_nova).replace('R$', '').trim()}"`,
                        `"${p.desconto_aplicado || 0}"`,
                        `"${formatarMoeda(p.simulacao_economia_mensal).replace('R$', '').trim()}"`,
                        `"${p.status}"`
                    ].join(';');
                });

                const csvContent = [cabecalho.join(';'), ...linhas].join('\n');
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                
                link.setAttribute("href", url);
                link.setAttribute("download", `relatorio_oby_financeiro_${new Date().toISOString().slice(0,10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                alert("Exporta√ß√£o iniciada! Verifique seus downloads.");
            };

            const totalEconomiaMensal = propostasAprovadas.reduce((sum, p) => sum + (parseFloat(p.simulacao_economia_mensal) || 0), 0);
            const totalCustoAtual = propostasAprovadas.reduce((sum, p) => sum + (parseFloat(p.simulacao_conta_atual) || 0), 0);
            const totalCustoNovo = propostasAprovadas.reduce((sum, p) => sum + (parseFloat(p.simulacao_conta_nova) || 0), 0);

            return (
                <div className="bg-white rounded-xl shadow-lg p-6">
                    <div className="flex justify-between items-center mb-6 border-b pb-4">
                        <h2 className="text-2xl font-bold text-gray-800">üìä Relat√≥rio Financeiro de Propostas Aprovadas</h2>
                        <button 
                            onClick={exportarParaCSV} 
                            className="px-4 py-2 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 disabled:opacity-50"
                            disabled={propostasAprovadas.length === 0}
                        >
                            ‚¨áÔ∏è Exportar para CSV
                        </button>
                    </div>

                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                        <div className="bg-blue-50 p-4 rounded-lg">
                            <p className="text-sm text-gray-600">Propostas V√°lidas</p>
                            <p className="text-2xl font-bold text-blue-800">{propostasAprovadas.length}</p>
                        </div>
                        <div className="bg-green-50 p-4 rounded-lg">
                            <p className="text-sm text-gray-600">Total Economia Mensal</p>
                            <p className="text-xl font-bold text-green-800">{formatarMoeda(totalEconomiaMensal)}</p>
                        </div>
                        <div className="bg-yellow-50 p-4 rounded-lg">
                            <p className="text-sm text-gray-600">Soma Custo Atual</p>
                            <p className="text-xl font-bold text-yellow-800">{formatarMoeda(totalCustoAtual)}</p>
                        </div>
                        <div className="bg-red-50 p-4 rounded-lg">
                            <p className="text-sm text-gray-600">Soma Custo OBY</p>
                            <p className="text-xl font-bold text-red-800">{formatarMoeda(totalCustoNovo)}</p>
                        </div>
                    </div>

                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">N¬∫ Contrato</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Cliente / Vendedor</th>
                                    <th className="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase">Consumo (kWh)</th>
                                    <th className="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase">Custo Atual</th>
                                    <th className="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase">Custo OBY</th>
                                    <th className="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase">Desconto (%)</th>
                                    <th className="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase">Economia Mensal</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {propostasAprovadas.length === 0 ? (
                                    <tr>
                                        <td colSpan="7" className="px-4 py-4 text-center text-gray-500">
                                            Nenhuma proposta aprovada com economia calculada para o relat√≥rio.
                                        </td>
                                    </tr>
                                ) : (
                                    propostasAprovadas.map(p => {
                                        const nomeCliente = p.nome && p.sobrenome ? `${p.nome} ${p.sobrenome}` : p.nome_fantasia || 'Sem nome';
                                        return (
                                            <tr key={p.id}>
                                                <td className="px-4 py-3 text-sm font-medium text-blue-600">{p.numero_contrato || '-'}</td>
                                                <td className="px-4 py-3 text-sm text-gray-900">
                                                    {nomeCliente}
                                                    <div className="text-xs text-gray-500">Vendedor: {p.vendedor || 'N/A'}</div>
                                                </td>
                                                <td className="px-4 py-3 text-sm text-right text-gray-600">{p.consumo_kwh || 0} kWh</td>
                                                <td className="px-4 py-3 text-sm text-right text-red-600 font-semibold">{formatarMoeda(p.simulacao_conta_atual)}</td>
                                                <td className="px-4 py-3 text-sm text-right text-green-600 font-semibold">{formatarMoeda(p.simulacao_conta_nova)}</td>
                                                <td className="px-4 py-3 text-sm text-right text-gray-600">{p.desconto_aplicado || 0}%</td>
                                                <td className="px-4 py-3 text-sm text-right font-bold text-green-800">{formatarMoeda(p.simulacao_economia_mensal)}</td>
                                            </tr>
                                        );
                                    })
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        // --- COMPONENTE DO MODAL DE EDI√á√ÉO ---
        function EditPropostaModal({ proposta, onClose, onSave, saving }) {
            
            const editableColumns = [
                'nome', 'sobrenome', 'nome_fantasia', 'email', 'telefone', 'cep', 'cidade', 'estado', 
                'cpf', 'cnpj', 'logradouro', 'numero_endereco', 'complemento', 'consumo_kwh', 
                'distribuidora_energia', 'status', 'tipo_pessoa', 'numero_instalacao', 
                'tipo_conexao', 'vendedor' 
            ];

            const [formData, setFormData] = useState({
                ...proposta,
                nome: proposta.nome || '',
                sobrenome: proposta.sobrenome || '',
                cpf: proposta.cpf || '',
                cnpj: proposta.cnpj || '',
                logradouro: proposta.logradouro || '',
                numero_endereco: proposta.numero_endereco || '',
                complemento: proposta.complemento || '',
                consumo_kwh: proposta.consumo_kwh || 0,
                distribuidora_energia: proposta.distribuidora_energia || '',
                vendedor: proposta.vendedor || ''
            });

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSave = () => {
                const dataToSave = { id: formData.id };
                
                if (!formData.numero_contrato || formData.numero_contrato === '-') {
                    const anoAtual = new Date().getFullYear();
                    const idCurto = String(formData.id).slice(-5);
                    dataToSave.numero_contrato = `OBY-${anoAtual}-${idCurto}`;
                }
                
                editableColumns.forEach(column => {
                    if (formData.hasOwnProperty(column)) {
                        let value = formData[column];
                        if (column === 'consumo_kwh') {
                            value = Number(value);
                        }
                        dataToSave[column] = value;
                    }
                });
                
                onSave(dataToSave);
            };

            const inputClass = "w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150";
            const labelClass = "block text-sm font-medium text-gray-700 mb-1";

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col">
                        <div className="p-6 border-b border-gray-200">
                            <h2 className="text-2xl font-bold text-gray-800">üìù Editar Proposta: {proposta.numero_contrato || 'N/A'}</h2>
                            <p className="text-sm text-gray-500">Altere os dados da proposta do cliente. O N√∫mero do Contrato n√£o pode ser editado.</p>
                        </div>

                        <div className="p-6 grid grid-cols-1 md:grid-cols-2 gap-6 overflow-y-auto">
                            {/* Informa√ß√µes do Contrato */}
                            <div className="md:col-span-2 bg-gray-100 p-4 rounded-lg border-l-4 border-gray-400">
                                <h3 className="font-bold text-lg mb-3 text-gray-700">Detalhes de Identifica√ß√£o</h3>
                                <div className="space-y-3">
                                    <div>
                                        <label className={labelClass}>N√∫mero do Contrato</label>
                                        <input type="text" value={proposta.numero_contrato || 'N/A'} disabled className={`${inputClass} bg-gray-200 cursor-not-allowed text-gray-700 font-semibold`} />
                                    </div>
                                </div>
                            </div>

                            {/* Dados Pessoais */}
                            <div className="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-400">
                                <h3 className="font-bold text-lg mb-4 text-blue-800">Dados Pessoais</h3>
                                <div className="space-y-4">
                                    <div>
                                        <label className={labelClass}>Nome</label>
                                        <input type="text" name="nome" value={formData.nome} onChange={handleChange} className={inputClass} />
                                    </div>
                                    <div>
                                        <label className={labelClass}>Sobrenome</label>
                                        <input type="text" name="sobrenome" value={formData.sobrenome} onChange={handleChange} className={inputClass} />
                                    </div>
                                    {formData.tipo_pessoa === 'juridica' && (
                                        <div>
                                            <label className={labelClass}>Nome Fantasia</label>
                                            <input type="text" name="nome_fantasia" value={formData.nome_fantasia || ''} onChange={handleChange} className={inputClass} />
                                        </div>
                                    )}
                                    <div>
                                        <label className={labelClass}>Email</label>
                                        <input type="email" name="email" value={formData.email || ''} onChange={handleChange} className={inputClass} />
                                    </div>
                                    <div>
                                        <label className={labelClass}>Telefone</label>
                                        <input type="text" name="telefone" value={formData.telefone || ''} onChange={handleChange} className={inputClass} />
                                    </div>
                                    <div>
                                        <label className={labelClass}>{formData.tipo_pessoa === 'fisica' ? 'CPF' : 'CNPJ'}</label>
                                        <input 
                                            type="text" 
                                            name={formData.tipo_pessoa === 'fisica' ? 'cpf' : 'cnpj'} 
                                            value={formData.tipo_pessoa === 'fisica' ? formData.cpf || '' : formData.cnpj || ''} 
                                            onChange={handleChange} 
                                            className={inputClass} 
                                        />
                                    </div>
                                    <div>
                                        <label className={labelClass}>Vendedor</label>
                                        <input type="text" name="vendedor" value={formData.vendedor || ''} onChange={handleChange} className={inputClass} />
                                    </div>
                                    <div>
                                        <label className={labelClass}>Status da Proposta</label>
                                        <select name="status" value={formData.status || 'pendente'} onChange={handleChange} className={inputClass}>
                                            <option value="pendente">üü° Pendente</option>
                                            <option value="aprovado">üü¢ Aprovado</option>
                                            <option value="reprovado">üî¥ Reprovado</option>
                                            <option value="lista_espera">üü† Lista de Espera</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            {/* Dados de Endere√ßo e Instala√ß√£o */}
                            <div className="bg-green-50 p-4 rounded-lg border-l-4 border-green-400">
                                <h3 className="font-bold text-lg mb-4 text-green-800">Endere√ßo e Instala√ß√£o</h3>
                                <div className="space-y-4">
                                    <div>
                                        <label className={labelClass}>CEP</label>
                                        <input type="text" name="cep" value={formData.cep || ''} onChange={handleChange} className={inputClass} />
                                    </div>
                                    <div>
                                        <label className={labelClass}>Logradouro</label>
                                        <input type="text" name="logradouro" value={formData.logradouro || ''} onChange={handleChange} className={inputClass} />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className={labelClass}>N√∫mero</label>
                                            <input type="text" name="numero_endereco" value={formData.numero_endereco || ''} onChange={handleChange} className={inputClass} />
                                        </div>
                                        <div>
                                            <label className={labelClass}>Complemento</label>
                                            <input type="text" name="complemento" value={formData.complemento || ''} onChange={handleChange} className={inputClass} />
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className={labelClass}>Cidade</label>
                                            <input type="text" name="cidade" value={formData.cidade || ''} onChange={handleChange} className={inputClass} />
                                        </div>
                                        <div>
                                            <label className={labelClass}>Estado (UF)</label>
                                            <input type="text" name="estado" value={formData.estado || ''} onChange={handleChange} className={inputClass} />
                                        </div>
                                    </div>
                                    <div>
                                        <label className={labelClass}>Distribuidora</label>
                                        <input type="text" name="distribuidora_energia" value={formData.distribuidora_energia || ''} onChange={handleChange} className={inputClass} />
                                    </div>
                                    <div>
                                        <label className={labelClass}>Consumo M√©dio (kWh)</label>
                                        <input type="number" step="1" name="consumo_kwh" value={formData.consumo_kwh || 0} onChange={handleChange} className={inputClass} />
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        {/* Bot√µes do Modal */}
                        <div className="p-6 flex justify-end gap-3 border-t border-gray-200">
                            <button onClick={onClose} className="px-6 py-3 bg-gray-500 text-white rounded-lg font-semibold hover:bg-gray-600">
                                Cancelar
                            </button>
                            <button onClick={handleSave} disabled={saving} className="px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 disabled:opacity-50">
                                {saving ? 'Salvando...' : 'üíæ Salvar Altera√ß√µes'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // --- COMPONENTE: GEST√ÉO DE VENDEDORES ---
        function VendedoresGestao() {
            const [vendedores, setVendedores] = useState([]);
            const [loading, setLoading] = useState(false);
            const [busca, setBusca] = useState('');
            const [filtroStatus, setFiltroStatus] = useState('todos');
            const [tabelaNaoExiste, setTabelaNaoExiste] = useState(false);
            const [modalAberto, setModalAberto] = useState(false);
            const [salvando, setSalvando] = useState(false);
            const [editandoId, setEditandoId] = useState(null);
            const [formData, setFormData] = useState({
                nome_completo: '',
                cpf: '',
                email: '',
                telefone: '',
                celular: '',
                codigo_vendedor: '',
                comissao_percentual: '5.00',
                status: 'ativo'
            });
            
            useEffect(() => {
                carregarVendedores();
            }, []);

            const carregarVendedores = async () => {
                setLoading(true);
                try {
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/vendedores?select=*&order=data_cadastro.desc`, {
                        headers: {
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'apikey': SUPABASE_KEY
                        }
                    });
                    
                    if (response.status === 404) {
                        setTabelaNaoExiste(true);
                        setVendedores([]);
                        return;
                    }
                    
                    if (response.ok) {
                        const data = await response.json();
                        setVendedores(data || []);
                        setTabelaNaoExiste(false);
                    }
                } catch (error) {
                    console.log('‚ÑπÔ∏è Tabela de vendedores ainda n√£o foi criada.');
                    setTabelaNaoExiste(true);
                } finally {
                    setLoading(false);
                }
            };

            const salvarVendedor = async (e) => {
                e.preventDefault();
                
                if (!formData.nome_completo || !formData.cpf || !formData.email || !formData.telefone) {
                    alert('‚ùå Preencha todos os campos obrigat√≥rios!');
                    return;
                }

                setSalvando(true);
                try {
                    const url = editandoId 
                        ? `${SUPABASE_URL}/rest/v1/vendedores?id=eq.${editandoId}`
                        : `${SUPABASE_URL}/rest/v1/vendedores`;
                    
                    const method = editandoId ? 'PATCH' : 'POST';
                    
                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'apikey': SUPABASE_KEY,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify(formData)
                    });

                    if (response.ok) {
                        alert(editandoId ? '‚úÖ Vendedor atualizado com sucesso!' : '‚úÖ Vendedor cadastrado com sucesso!');
                        setModalAberto(false);
                        setEditandoId(null);
                        setFormData({
                            nome_completo: '',
                            cpf: '',
                            email: '',
                            telefone: '',
                            celular: '',
                            codigo_vendedor: '',
                            comissao_percentual: '5.00',
                            status: 'ativo'
                        });
                        carregarVendedores();
                    } else {
                        const error = await response.json();
                        alert(`‚ùå Erro ao salvar: ${error.message || 'Erro desconhecido'}`);
                    }
                } catch (error) {
                    alert('‚ùå Erro ao salvar vendedor: ' + error.message);
                } finally {
                    setSalvando(false);
                }
            };

            const abrirEdicao = (vendedor) => {
                setEditandoId(vendedor.id);
                setFormData({
                    nome_completo: vendedor.nome_completo || '',
                    cpf: vendedor.cpf || '',
                    email: vendedor.email || '',
                    telefone: vendedor.telefone || '',
                    celular: vendedor.celular || '',
                    codigo_vendedor: vendedor.codigo_vendedor || '',
                    comissao_percentual: vendedor.comissao_percentual || '5.00',
                    status: vendedor.status || 'ativo'
                });
                setModalAberto(true);
            };

            const alternarStatus = async (vendedor) => {
                const novoStatus = vendedor.status === 'ativo' ? 'inativo' : 'ativo';
                const confirmacao = confirm(`Deseja realmente ${novoStatus === 'inativo' ? 'INATIVAR' : 'ATIVAR'} o vendedor ${vendedor.nome_completo}?`);
                
                if (!confirmacao) return;

                try {
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/vendedores?id=eq.${vendedor.id}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'apikey': SUPABASE_KEY,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify({ status: novoStatus })
                    });

                    if (response.ok) {
                        alert(`‚úÖ Vendedor ${novoStatus === 'inativo' ? 'inativado' : 'ativado'} com sucesso!`);
                        carregarVendedores();
                    } else {
                        const error = await response.json();
                        alert(`‚ùå Erro ao alterar status: ${error.message || 'Erro desconhecido'}`);
                    }
                } catch (error) {
                    alert('‚ùå Erro ao alterar status: ' + error.message);
                }
            };

            const vendedoresFiltrados = vendedores.filter(v => {
                const matchStatus = filtroStatus === 'todos' || v.status === filtroStatus;
                const matchBusca = !busca || 
                    v.nome_completo?.toLowerCase().includes(busca.toLowerCase()) ||
                    v.email?.toLowerCase().includes(busca.toLowerCase()) ||
                    v.codigo_vendedor?.toLowerCase().includes(busca.toLowerCase());
                return matchStatus && matchBusca;
            });

            return (
                <div className="bg-white rounded-xl shadow-lg p-6">
                    <div className="flex justify-between items-center mb-6 border-b pb-4">
                        <h2 className="text-2xl font-bold text-gray-800">üë• Gest√£o de Vendedores</h2>
                        <button 
                            onClick={() => setModalAberto(true)} 
                            className="px-6 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700"
                        >
                            ‚ûï Novo Vendedor
                        </button>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <input
                            type="text"
                            placeholder="üîç Buscar por nome, email ou c√≥digo..."
                            value={busca}
                            onChange={(e) => setBusca(e.target.value)}
                            className="w-full p-3 border border-gray-300 rounded-lg"
                        />
                        <select
                            value={filtroStatus}
                            onChange={(e) => setFiltroStatus(e.target.value)}
                            className="w-full p-3 border border-gray-300 rounded-lg"
                        >
                            <option value="todos">Todos os Status</option>
                            <option value="ativo">Ativos</option>
                            <option value="inativo">Inativos</option>
                        </select>
                    </div>

                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div className="bg-blue-50 p-4 rounded-lg">
                            <p className="text-sm text-gray-600">Total</p>
                            <p className="text-2xl font-bold text-blue-800">{vendedores.length}</p>
                        </div>
                        <div className="bg-green-50 p-4 rounded-lg">
                            <p className="text-sm text-gray-600">Ativos</p>
                            <p className="text-2xl font-bold text-green-800">
                                {vendedores.filter(v => v.status === 'ativo').length}
                            </p>
                        </div>
                        <div className="bg-yellow-50 p-4 rounded-lg">
                            <p className="text-sm text-gray-600">Inativos</p>
                            <p className="text-2xl font-bold text-yellow-800">
                                {vendedores.filter(v => v.status === 'inativo').length}
                            </p>
                        </div>
                        <div className="bg-purple-50 p-4 rounded-lg">
                            <p className="text-sm text-gray-600">Com Vendas</p>
                            <p className="text-2xl font-bold text-purple-800">
                                {vendedores.filter(v => v.ultima_venda).length}
                            </p>
                        </div>
                    </div>

                    {loading ? (
                        <div className="text-center py-8">
                            <p className="text-gray-600">‚è≥ Carregando vendedores...</p>
                        </div>
                    ) : tabelaNaoExiste || vendedoresFiltrados.length === 0 ? (
                        <div className="text-center py-8 bg-gray-50 rounded-lg">
                            <p className="text-gray-600 mb-2">üì≠ Nenhum vendedor encontrado</p>
                        </div>
                    ) : (
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">C√≥digo</th>
                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nome</th>
                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Telefone</th>
                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Comiss√£o</th>
                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                        <th className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {vendedoresFiltrados.map(vendedor => (
                                        <tr key={vendedor.id} className="hover:bg-gray-50">
                                            <td className="px-4 py-3 text-sm font-mono text-gray-900">
                                                {vendedor.codigo_vendedor}
                                            </td>
                                            <td className="px-4 py-3 text-sm text-gray-900">
                                                {vendedor.nome_completo}
                                            </td>
                                            <td className="px-4 py-3 text-sm text-gray-600">
                                                {vendedor.email}
                                            </td>
                                            <td className="px-4 py-3 text-sm text-gray-600">
                                                {vendedor.telefone}
                                            </td>
                                            <td className="px-4 py-3 text-sm font-semibold text-green-600">
                                                {vendedor.comissao_percentual}%
                                            </td>
                                            <td className="px-4 py-3 text-sm">
                                                <span className={`px-2 py-1 rounded-full text-xs font-semibold ${
                                                    vendedor.status === 'ativo' 
                                                        ? 'bg-green-100 text-green-800' 
                                                        : 'bg-gray-100 text-gray-800'
                                                }`}>
                                                    {vendedor.status === 'ativo' ? '‚úÖ Ativo' : '‚è∏Ô∏è Inativo'}
                                                </span>
                                            </td>
                                            <td className="px-4 py-3 text-sm">
                                                <div className="flex gap-2 justify-center">
                                                    <button
                                                        onClick={() => abrirEdicao(vendedor)}
                                                        className="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs font-semibold"
                                                    >
                                                        ‚úèÔ∏è Editar
                                                    </button>
                                                    <button
                                                        onClick={() => alternarStatus(vendedor)}
                                                        className={`px-3 py-1 text-white rounded text-xs font-semibold ${
                                                            vendedor.status === 'ativo'
                                                                ? 'bg-red-600 hover:bg-red-700'
                                                                : 'bg-green-600 hover:bg-green-700'
                                                        }`}
                                                    >
                                                        {vendedor.status === 'ativo' ? 'üö´ Inativar' : '‚úÖ Ativar'}
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}

                    {/* MODAL DE CADASTRO/EDI√á√ÉO */}
                    {modalAberto && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                                <div className="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center">
                                    <h3 className="text-xl font-bold text-gray-800">
                                        {editandoId ? '‚úèÔ∏è Editar Vendedor' : '‚ûï Cadastrar Novo Vendedor'}
                                    </h3>
                                    <button 
                                        onClick={() => {
                                            setModalAberto(false);
                                            setEditandoId(null);
                                        }} 
                                        className="text-gray-500 hover:text-gray-700 text-2xl font-bold"
                                    >
                                        √ó
                                    </button>
                                </div>

                                <form onSubmit={salvarVendedor} className="p-6">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div className="md:col-span-2">
                                            <label className="block text-sm font-semibold text-gray-700 mb-2">
                                                üë§ Nome Completo <span className="text-red-500">*</span>
                                            </label>
                                            <input
                                                type="text"
                                                required
                                                value={formData.nome_completo}
                                                onChange={(e) => setFormData({...formData, nome_completo: e.target.value})}
                                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-semibold text-gray-700 mb-2">
                                                ü™™ CPF <span className="text-red-500">*</span>
                                            </label>
                                            <input
                                                type="text"
                                                required
                                                value={formData.cpf}
                                                onChange={(e) => setFormData({...formData, cpf: e.target.value})}
                                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                                maxLength="14"
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-semibold text-gray-700 mb-2">
                                                üìß Email <span className="text-red-500">*</span>
                                            </label>
                                            <input
                                                type="email"
                                                required
                                                value={formData.email}
                                                onChange={(e) => setFormData({...formData, email: e.target.value})}
                                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-semibold text-gray-700 mb-2">
                                                üìû Telefone <span className="text-red-500">*</span>
                                            </label>
                                            <input
                                                type="text"
                                                required
                                                value={formData.telefone}
                                                onChange={(e) => setFormData({...formData, telefone: e.target.value})}
                                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-semibold text-gray-700 mb-2">
                                                üì± Celular (Opcional)
                                            </label>
                                            <input
                                                type="text"
                                                value={formData.celular}
                                                onChange={(e) => setFormData({...formData, celular: e.target.value})}
                                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-semibold text-gray-700 mb-2">
                                                üî¢ C√≥digo do Vendedor
                                            </label>
                                            <input
                                                type="text"
                                                value={formData.codigo_vendedor}
                                                onChange={(e) => setFormData({...formData, codigo_vendedor: e.target.value.toUpperCase()})}
                                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-semibold text-gray-700 mb-2">
                                                üí∞ Comiss√£o (%)
                                            </label>
                                            <input
                                                type="number"
                                                step="0.01"
                                                min="0"
                                                max="100"
                                                value={formData.comissao_percentual}
                                                onChange={(e) => setFormData({...formData, comissao_percentual: e.target.value})}
                                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                            />
                                        </div>

                                        <div className="md:col-span-2">
                                            <label className="block text-sm font-semibold text-gray-700 mb-2">
                                                üìä Status
                                            </label>
                                            <select
                                                value={formData.status}
                                                onChange={(e) => setFormData({...formData, status: e.target.value})}
                                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                            >
                                                <option value="ativo">‚úÖ Ativo</option>
                                                <option value="inativo">‚è∏Ô∏è Inativo</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div className="flex gap-4 mt-6 pt-6 border-t">
                                        <button
                                            type="button"
                                            onClick={() => {
                                                setModalAberto(false);
                                                setEditandoId(null);
                                            }}
                                            className="flex-1 px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300"
                                        >
                                            Cancelar
                                        </button>
                                        <button
                                            type="submit"
                                            disabled={salvando}
                                            className="flex-1 px-6 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 disabled:opacity-50"
                                        >
                                            {salvando ? '‚è≥ Salvando...' : editandoId ? '‚úÖ Atualizar Vendedor' : '‚úÖ Salvar Vendedor'}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // --- COMPONENTE PRINCIPAL: ADMIN PANEL ---
        function AdminPanel() {
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [propostas, setPropostas] = useState([]);
            const [loading, setLoading] = useState(false);
            const [selectedProposta, setSelectedProposta] = useState(null); 
            const [propostaAnexos, setPropostaAnexos] = useState(null); 
            const [savingProposta, setSavingProposta] = useState(false); 
            const [filtro, setFiltro] = useState('todos');
            const [busca, setBusca] = useState('');
            const [activeTab, setActiveTab] = useState('propostas');
            const [tarifaKwh, setTarifaKwh] = useState('0.842355');
            const [proporcaoEnergia, setProporcaoEnergia] = useState('0.81');
            const [proporcaoImpostos, setProporcaoImpostos] = useState('0.19');
            const [descontoPercentual, setDescontoPercentual] = useState('15');
            const [consumoMinimoValor, setConsumoMinimoValor] = useState('0');
            const [tarifaId, setTarifaId] = useState(null);
            const [proporcaoEnergiaId, setProporcaoEnergiaId] = useState(null);
            const [proporcaoImpostosId, setProporcaoImpostosId] = useState(null);
            const [descontoId, setDescontoId] = useState(null);
            const [consumoMinimoId, setConsumoMinimoId] = useState(null);
            const [savingConfig, setSavingConfig] = useState(false);

            useEffect(() => {
                const authStatus = localStorage.getItem('oby_admin_auth');
                if (authStatus === 'true') {
                    setIsAuthenticated(true);
                    carregarPropostas();
                    carregarConfiguracoes();
                }
            }, []);

            const handleLogin = (e) => {
                e.preventDefault();
                if (username === ADMIN_USER && password === ADMIN_PASS) {
                    setIsAuthenticated(true);
                    localStorage.setItem('oby_admin_auth', 'true');
                    carregarPropostas();
                    carregarConfiguracoes();
                } else {
                    alert('Usu√°rio ou senha incorretos!');
                }
            };

            const handleLogout = () => {
                setIsAuthenticated(false);
                localStorage.removeItem('oby_admin_auth');
                setUsername('');
                setPassword('');
            };

            const carregarPropostas = async () => {
                setLoading(true);
                try {
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/propostas?select=*,vendedores(nome_completo)&order=data_criacao.desc`, {
                        headers: {
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'apikey': SUPABASE_KEY
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Erro ${response.status}`);
                    }
                    
                    const data = await response.json();
                    setPropostas(data.map(p => ({
                        ...p, 
                        vendedor: p.vendedores?.nome_completo || p.vendedor || '-',
                        showMenu: false, 
                        updating: false
                    })));
                } catch (error) {
                    console.error('‚ùå Erro ao carregar propostas:', error);
                    setPropostas([]);
                } finally {
                    setLoading(false);
                }
            };

            const handleEditClick = (proposta) => {
                setSelectedProposta(proposta);
            };

            const handleSaveEdit = async (dataToSave) => {
                setSavingProposta(true);
                
                const propostaId = dataToSave.id;
                const { id, ...payloadForSupabase } = dataToSave; 
                
                try {
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/propostas?id=eq.${propostaId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'apikey': SUPABASE_KEY,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify(payloadForSupabase)
                    });

                    if (response.ok) {
                        const data = await response.json();
                        setPropostas(prev => prev.map(p => 
                            p.id === propostaId ? {...data[0], showMenu: false, updating: false} : p
                        ));
                        setSelectedProposta(null);
                        alert('‚úÖ Proposta atualizada com sucesso!');
                    } else {
                        const errorText = await response.text();
                        alert('‚ùå Erro ao salvar proposta: ' + errorText);
                    }
                } catch (error) {
                    alert('Erro inesperado ao salvar proposta.');
                } finally {
                    setSavingProposta(false);
                }
            };

            const carregarConfiguracoes = async () => {
                try {
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/configuracoes?select=*`, {
                        headers: {
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'apikey': SUPABASE_KEY
                        }
                    });
                    const data = await response.json();
                    
                    if (data && data.length > 0) {
                        data.forEach(config => {
                            if (config.chave === 'tarifa_kwh') {
                                setTarifaKwh(config.valor);
                                setTarifaId(config.id);
                            }
                            if (config.chave === 'proporcao_energia') {
                                setProporcaoEnergia(config.valor);
                                setProporcaoEnergiaId(config.id);
                            }
                            if (config.chave === 'proporcao_impostos') {
                                setProporcaoImpostos(config.valor);
                                setProporcaoImpostosId(config.id);
                            }
                            if (config.chave === 'desconto_percentual') {
                                setDescontoPercentual(config.valor);
                                setDescontoId(config.id);
                            }
                            if (config.chave === 'consumo_minimo_valor') {
                                setConsumoMinimoValor(config.valor);
                                setConsumoMinimoId(config.id);
                            }
                        });
                    }
                } catch (error) {
                    console.error('‚ùå Erro ao carregar configura√ß√µes:', error);
                }
            };

            const salvarConfiguracoes = async () => {
                setSavingConfig(true);
                try {
                    if (tarifaId) {
                        await fetch(`${SUPABASE_URL}/rest/v1/configuracoes?id=eq.${tarifaId}`, {
                            method: 'PATCH',
                            headers: {
                                'Authorization': `Bearer ${SUPABASE_KEY}`,
                                'apikey': SUPABASE_KEY,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ valor: String(tarifaKwh) })
                        });
                    }

                    if (proporcaoEnergiaId) {
                        await fetch(`${SUPABASE_URL}/rest/v1/configuracoes?id=eq.${proporcaoEnergiaId}`, {
                            method: 'PATCH',
                            headers: {
                                'Authorization': `Bearer ${SUPABASE_KEY}`,
                                'apikey': SUPABASE_KEY,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ valor: String(proporcaoEnergia) })
                        });
                    }

                    if (proporcaoImpostosId) {
                        await fetch(`${SUPABASE_URL}/rest/v1/configuracoes?id=eq.${proporcaoImpostosId}`, {
                            method: 'PATCH',
                            headers: {
                                'Authorization': `Bearer ${SUPABASE_KEY}`,
                                'apikey': SUPABASE_KEY,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ valor: String(proporcaoImpostos) })
                        });
                    }

                    if (descontoId) {
                        await fetch(`${SUPABASE_URL}/rest/v1/configuracoes?id=eq.${descontoId}`, {
                            method: 'PATCH',
                            headers: {
                                'Authorization': `Bearer ${SUPABASE_KEY}`,
                                'apikey': SUPABASE_KEY,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ valor: String(descontoPercentual) })
                        });
                    }

                    if (consumoMinimoId) {
                        await fetch(`${SUPABASE_URL}/rest/v1/configuracoes?id=eq.${consumoMinimoId}`, {
                            method: 'PATCH',
                            headers: {
                                'Authorization': `Bearer ${SUPABASE_KEY}`,
                                'apikey': SUPABASE_KEY,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ valor: String(consumoMinimoValor) })
                        });
                    }

                    alert('‚úÖ Configura√ß√µes atualizadas com sucesso!');
                    await carregarConfiguracoes();
                } catch (error) {
                    alert('Erro ao salvar configura√ß√µes.');
                } finally {
                    setSavingConfig(false);
                }
            };

            const gerarNumeroContrato = async (proposta) => {
                if (proposta.numero_contrato && proposta.numero_contrato !== '-') {
                    alert('Esta proposta j√° tem n√∫mero de contrato!');
                    return;
                }
                
                const anoAtual = new Date().getFullYear();
                const idCurto = String(proposta.id).slice(-5);
                const numeroContrato = `OBY-${anoAtual}-${idCurto}`;
                
                try {
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/propostas?id=eq.${proposta.id}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'apikey': SUPABASE_KEY,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ numero_contrato: numeroContrato })
                    });
                    
                    if (response.ok) {
                        alert(`‚úÖ N√∫mero gerado: ${numeroContrato}`);
                        carregarPropostas();
                    } else {
                        alert('‚ùå Erro ao gerar n√∫mero de contrato');
                    }
                } catch (error) {
                    alert('‚ùå Erro ao gerar n√∫mero de contrato: ' + error.message);
                }
            };

            const gerarEBaixarContrato = async (proposta) => {
                try {
                    // Buscar templates
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/contrato_templates?select=*&order=ordem.asc`, {
                        headers: {
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'apikey': SUPABASE_KEY
                        }
                    });
                    const templates = await response.json();
                    let contratoCompleto = templates.map(t => t.texto).join('\n\n');
                    
                    // Preparar dados
                    const nomeCliente = proposta.nome && proposta.sobrenome 
                        ? `${proposta.nome} ${proposta.sobrenome}`
                        : proposta.nome_fantasia || 'Sem nome';
                    
                    const cpfCnpj = proposta.tipo_pessoa === 'fisica' ? proposta.cpf : proposta.cnpj;
                    const enderecoCompleto = `${proposta.logradouro || ''}, ${proposta.numero_endereco || ''} ${proposta.complemento ? '- ' + proposta.complemento : ''}, ${proposta.bairro || ''}, ${proposta.cidade || ''} - ${proposta.estado || ''}`.trim();
                    const dataAtual = new Date().toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    
                    // Substituir placeholders
                    contratoCompleto = contratoCompleto
                        .replace(/\[Nome do Cliente\]/g, nomeCliente)
                        .replace(/\[CPF\/CNPJ\]/g, cpfCnpj || 'N/A')
                        .replace(/\[Email\]/g, proposta.email || 'N/A')
                        .replace(/\[Telefone\]/g, proposta.telefone || 'N/A')
                        .replace(/\[Endere√ßo Completo\]/g, enderecoCompleto)
                        .replace(/\[Logradouro\]/g, proposta.logradouro || 'N/A')
                        .replace(/\[N√∫mero\]/g, proposta.numero_endereco || 'N/A')
                        .replace(/\[Complemento\]/g, proposta.complemento || '')
                        .replace(/\[Bairro\]/g, proposta.bairro || 'N/A')
                        .replace(/\[Cidade\]/g, proposta.cidade || 'N/A')
                        .replace(/\[Estado\]/g, proposta.estado || 'N/A')
                        .replace(/\[CEP\]/g, proposta.cep || 'N/A')
                        .replace(/\[N√∫mero da Instala√ß√£o\]/g, proposta.numero_instalacao || 'N/A')
                        .replace(/\[Distribuidora\]/g, proposta.distribuidora_energia || 'N/A')
                        .replace(/\[Consumo\]/g, proposta.consumo_kwh || '0')
                        .replace(/\[Tipo de Conex√£o\]/g, proposta.tipo_conexao || 'N/A')
                        .replace(/\[N√∫mero do Contrato\]/g, proposta.numero_contrato || 'N/A')
                        .replace(/\[Data\]/g, dataAtual)
                        .replace(/\[X\]/g, proposta.desconto_aplicado || '15')
                        .replace(/\[Custo Atual\]/g, `R$ ${parseFloat(proposta.simulacao_conta_atual || 0).toFixed(2)}`)
                        .replace(/\[Custo OBY\]/g, `R$ ${parseFloat(proposta.simulacao_conta_nova || 0).toFixed(2)}`)
                        .replace(/\[Economia Mensal\]/g, `R$ ${parseFloat(proposta.simulacao_economia_mensal || 0).toFixed(2)}`);
                    
                    // Criar documento DOCX
                    const paragrafos = contratoCompleto.split('\n').map(linha => {
                        return new docx.Paragraph({
                            text: linha,
                            spacing: { after: 200 }
                        });
                    });
                    
                    const doc = new docx.Document({
                        sections: [{
                            properties: {},
                            children: [
                                new docx.Paragraph({
                                    text: "CONTRATO DE FORNECIMENTO DE ENERGIA",
                                    heading: docx.HeadingLevel.HEADING_1,
                                    alignment: docx.AlignmentType.CENTER,
                                    spacing: { after: 400 }
                                }),
                                new docx.Paragraph({
                                    text: `Contrato N¬∫: ${proposta.numero_contrato || 'N/A'}`,
                                    bold: true,
                                    spacing: { after: 400 }
                                }),
                                new docx.Paragraph({
                                    text: `Cliente: ${nomeCliente}`,
                                    spacing: { after: 200 }
                                }),
                                new docx.Paragraph({
                                    text: `CPF/CNPJ: ${cpfCnpj || 'N/A'}`,
                                    spacing: { after: 400 }
                                }),
                                ...paragrafos
                            ]
                        }]
                    });
                    
                    // Gerar e baixar
                    docx.Packer.toBlob(doc).then(blob => {
                        saveAs(blob, `Contrato_${proposta.numero_contrato || 'OBY'}.docx`);
                        alert('‚úÖ Contrato DOCX gerado e baixado!');
                    });
                    
                } catch (error) {
                    console.error('Erro:', error);
                    alert('‚ùå Erro ao gerar contrato: ' + error.message);
                }
            };

            const formatarData = (dataISO) => {
                const data = new Date(dataISO);
                return data.toLocaleDateString('pt-BR');
            };

            const handleSubstituirAnexo = async (e, propostaId, campo, nomeCampo) => {
                const file = e.target.files[0];
                if (!file) return;

                if (file.size > 10 * 1024 * 1024) {
                    alert('‚ùå Arquivo muito grande! Tamanho m√°ximo: 10MB');
                    return;
                }

                const confirmar = confirm(`Deseja substituir o arquivo "${nomeCampo}"?\n\nArquivo: ${file.name}\nTamanho: ${(file.size / 1024 / 1024).toFixed(2)} MB`);
                if (!confirmar) return;

                try {
                    const timestamp = Date.now();
                    const fileExtension = file.name.split('.').pop();
                    const fileName = `${nomeCampo}_${timestamp}.${fileExtension}`;
                    
                    const formData = new FormData();
                    formData.append('file', file);

                    const uploadResponse = await fetch(`${SUPABASE_URL}/storage/v1/object/propostas/${fileName}`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'apikey': SUPABASE_KEY
                        },
                        body: formData
                    });

                    if (!uploadResponse.ok) {
                        const errorData = await uploadResponse.json();
                        throw new Error(errorData.message || 'Erro ao fazer upload do arquivo');
                    }

                    const fileUrl = `${SUPABASE_URL}/storage/v1/object/public/propostas/${fileName}`;

                    const updateResponse = await fetch(`${SUPABASE_URL}/rest/v1/propostas?id=eq.${propostaId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'apikey': SUPABASE_KEY,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify({ [campo]: fileUrl })
                    });

                    if (!updateResponse.ok) {
                        throw new Error('Erro ao atualizar banco de dados');
                    }

                    alert('‚úÖ Arquivo substitu√≠do com sucesso!');
                    
                    carregarPropostas();
                    
                    const updatedData = await updateResponse.json();
                    setPropostaAnexos(updatedData[0]);

                } catch (error) {
                    alert('‚ùå Erro ao substituir arquivo: ' + error.message);
                    console.error('Erro completo:', error);
                }

                e.target.value = '';
            };

            const getStatusBadge = (status) => {
                const configs = {
                    'pendente': { bg: 'bg-yellow-100', text: 'text-yellow-800', label: 'üü° Pendente' },
                    'aprovado': { bg: 'bg-green-100', text: 'text-green-800', label: 'üü¢ Aprovado' },
                    'reprovado': { bg: 'bg-red-100', text: 'text-red-800', label: 'üî¥ Reprovado' },
                    'lista_espera': { bg: 'bg-orange-100', text: 'text-orange-800', label: 'üü† Lista Espera' }
                };
                const config = configs[status] || configs['pendente'];
                return (
                    <span className={`px-3 py-1 rounded-full text-xs font-semibold ${config.bg} ${config.text}`}>
                        {config.label}
                    </span>
                );
            };

            const propostasFiltradas = propostas.filter(proposta => {
                const matchFiltro = filtro === 'todos' || proposta.status === filtro;
                const nomeCompleto = proposta.nome && proposta.sobrenome 
                    ? `${proposta.nome} ${proposta.sobrenome}` 
                    : proposta.nome_fantasia || '';
                const matchBusca = busca === '' || 
                    nomeCompleto.toLowerCase().includes(busca.toLowerCase()) ||
                    proposta.email?.toLowerCase().includes(busca.toLowerCase()) ||
                    proposta.cidade?.toLowerCase().includes(busca.toLowerCase());
                return matchFiltro && matchBusca;
            });

            const abrirSistemaContratos = () => {
                window.open('contratos.html', '_blank');
            };

            if (!isAuthenticated) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
                            <div className="text-center mb-8">
                                <h1 className="text-3xl font-bold text-gray-800 mb-2">üîê Admin OBY Energy</h1>
                                <p className="text-gray-600">Fa√ßa login para acessar o painel</p>
                            </div>
                            <form onSubmit={handleLogin} className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Usu√°rio</label>
                                    <input 
                                        type="text" 
                                        value={username} 
                                        onChange={(e) => setUsername(e.target.value)}
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                        required
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                                    <input 
                                        type="password" 
                                        value={password} 
                                        onChange={(e) => setPassword(e.target.value)}
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                        required
                                    />
                                </div>
                                <button 
                                    type="submit" 
                                    className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition"
                                >
                                    Entrar
                                </button>
                            </form>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-100">
                    <header className="bg-white shadow-md">
                        <div className="container mx-auto px-4 py-4 flex justify-between items-center">
                            <h1 className="text-2xl font-bold text-blue-600">‚ö° OBY Energy Admin</h1>
                            <div className="flex gap-4">
                                <button 
                                    onClick={abrirSistemaContratos}
                                    className="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 font-semibold"
                                >
                                    üìÑ Sistema de Contratos
                                </button>
                                <button onClick={handleLogout} className="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
                                    Sair
                                </button>
                            </div>
                        </div>
                    </header>

                    <div className="container mx-auto px-4 py-8">
                        <div className="mb-6 border-b border-gray-200">
                            <div className="flex space-x-2">
                                <button onClick={() => setActiveTab('propostas')} className={`px-6 py-3 font-semibold transition ${activeTab === 'propostas' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600 hover:text-blue-600'}`}>
                                    üìã Propostas
                                </button>
                                <button onClick={() => setActiveTab('configuracoes')} className={`px-6 py-3 font-semibold transition ${activeTab === 'configuracoes' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600 hover:text-blue-600'}`}>
                                    ‚öôÔ∏è Configura√ß√µes
                                </button>
                                <button onClick={() => setActiveTab('financeiro')} className={`px-6 py-3 font-semibold transition ${activeTab === 'financeiro' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600 hover:text-blue-600'}`}>
                                    üìä Relat√≥rio Financeiro
                                </button>
                                <button onClick={() => setActiveTab('vendedores')} className={`px-6 py-3 font-semibold transition ${activeTab === 'vendedores' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600 hover:text-blue-600'}`}>
                                    üë• Vendedores
                                </button>
                            </div>
                        </div>

                        {activeTab === 'configuracoes' ? (
                            <div className="bg-white rounded-xl shadow-lg p-6 max-w-2xl">
                                <h2 className="text-2xl font-bold mb-6 text-gray-800">‚öôÔ∏è Configura√ß√µes do Sistema</h2>
                                
                                <div className="space-y-6">
                                    <div className="bg-blue-50 p-6 rounded-lg">
                                        <h3 className="font-bold text-lg mb-4 text-blue-800">üí∞ Configura√ß√µes de Tarifa</h3>
                                        <div className="space-y-4">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">Tarifa Total (R$/kWh)</label>
                                                <input type="number" step="0.000001" value={tarifaKwh} onChange={(e) => setTarifaKwh(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg" />
                                            </div>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">Propor√ß√£o Energia</label>
                                                    <input type="number" step="0.01" value={proporcaoEnergia} onChange={(e) => setProporcaoEnergia(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg" />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">Propor√ß√£o Impostos</label>
                                                    <input type="number" step="0.01" value={proporcaoImpostos} onChange={(e) => setProporcaoImpostos(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg" />
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="bg-green-50 p-6 rounded-lg">
                                        <h3 className="font-bold text-lg mb-4 text-green-800">üéØ Configura√ß√£o de Desconto</h3>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">Desconto Percentual (%)</label>
                                            <div className="flex items-center gap-3">
                                                <input 
                                                    type="number" 
                                                    step="0.1" 
                                                    min="0" 
                                                    max="100"
                                                    value={descontoPercentual} 
                                                    onChange={(e) => setDescontoPercentual(e.target.value)} 
                                                    className="flex-1 p-3 border border-gray-300 rounded-lg"
                                                />
                                                <span className="text-2xl font-bold text-green-600">%</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="bg-purple-50 p-6 rounded-lg">
                                        <h3 className="font-bold text-lg mb-4 text-purple-800">üí° Consumo M√≠nimo</h3>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                Valor do Consumo M√≠nimo (R$)
                                            </label>
                                            <div className="flex items-center gap-3">
                                                <span className="text-2xl font-bold text-purple-600">R$</span>
                                                <input 
                                                    type="number" 
                                                    step="0.01" 
                                                    min="0"
                                                    value={consumoMinimoValor} 
                                                    onChange={(e) => setConsumoMinimoValor(e.target.value)} 
                                                    className="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                                />
                                            </div>
                                            <p className="text-xs text-gray-500 mt-2">
                                                ‚ÑπÔ∏è Valor fixo cobrado pela distribuidora para o consumo m√≠nimo (ex: 100 kWh na COPEL = R$ 84,24)
                                            </p>
                                        </div>
                                    </div>

                                    <button onClick={salvarConfiguracoes} disabled={savingConfig} className="w-full px-6 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 disabled:opacity-50">
                                        {savingConfig ? 'üíæ Salvando...' : 'üíæ Salvar Todas as Configura√ß√µes'}
                                    </button>
                                </div>
                            </div>
                        ) : activeTab === 'financeiro' ? (
                            <FinancialReport propostas={propostas} />
                        ) : activeTab === 'vendedores' ? (
                            <VendedoresGestao />
                        ) : (
                            <>
                                <div className="bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl shadow-lg p-6 text-white mb-6">
                                    <h2 className="text-3xl font-bold mb-2">Bem-vindo ao Painel Administrativo! üëã</h2>
                                    <p className="text-blue-100">Gerencie as propostas de energia de forma simples e eficiente</p>
                                    <div className="mt-4 flex gap-4">
                                        <div className="bg-white/20 backdrop-blur-sm rounded-lg px-4 py-2">
                                            <p className="text-sm">Total de Propostas</p>
                                            <p className="text-2xl font-bold">{propostas.length}</p>
                                        </div>
                                        <div className="bg-white/20 backdrop-blur-sm rounded-lg px-4 py-2">
                                            <p className="text-sm">Pendentes</p>
                                            <p className="text-2xl font-bold">{propostas.filter(p => p.status === 'pendente').length}</p>
                                        </div>
                                        <div className="bg-white/20 backdrop-blur-sm rounded-lg px-4 py-2">
                                            <p className="text-sm">Aprovadas</p>
                                            <p className="text-2xl font-bold">{propostas.filter(p => p.status === 'aprovado').length}</p>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-white rounded-xl shadow-lg p-6">
                                    <div className="mb-6 flex flex-col md:flex-row gap-4">
                                        <input type="text" placeholder="üîç Buscar..." value={busca} onChange={(e) => setBusca(e.target.value)} className="flex-1 p-3 border border-gray-300 rounded-lg" />
                                        <select value={filtro} onChange={(e) => setFiltro(e.target.value)} className="p-3 border border-gray-300 rounded-lg">
                                            <option value="todos">Todos</option>
                                            <option value="pendente">Pendente</option>
                                            <option value="aprovado">Aprovado</option>
                                            <option value="reprovado">Reprovado</option>
                                            <option value="lista_espera">Lista de Espera</option>
                                        </select>
                                    </div>

                                    <div className="overflow-x-auto">
                                        <table className="w-full">
                                            <thead className="bg-gray-50 border-b-2 border-gray-200">
                                                <tr>
                                                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Nome</th>
                                                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">N¬∫ Contrato</th>
                                                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Email</th>
                                                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Cidade</th>
                                                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Telefone</th>
                                                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">CPF</th>
                                                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase bg-yellow-50">üî• VENDEDOR</th>
                                                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Data</th>
                                                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Status</th>
                                                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">A√ß√µes</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-gray-200">
                                                {propostasFiltradas.length === 0 ? (
                                                    <tr>
                                                        <td colSpan="10" className="px-4 py-8 text-center text-gray-500">
                                                            {loading ? 'Carregando...' : 'Nenhuma proposta encontrada'}
                                                        </td>
                                                    </tr>
                                                ) : (
                                                    propostasFiltradas.map((proposta) => {
                                                        const nomeCompleto = proposta.nome && proposta.sobrenome 
                                                            ? `${proposta.nome} ${proposta.sobrenome}`
                                                            : proposta.nome_fantasia || 'Sem nome';
                                                        
                                                        return (
                                                            <tr key={proposta.id} className="hover:bg-gray-50">
                                                                <td className="px-4 py-3 text-sm font-medium text-gray-900">
                                                                    {nomeCompleto}
                                                                </td>
                                                                <td className="px-4 py-3 text-sm font-semibold text-blue-600">
                                                                    {proposta.numero_contrato || '-'}
                                                                </td>
                                                                <td className="px-4 py-3 text-sm text-gray-600">{proposta.email}</td>
                                                                <td className="px-4 py-3 text-sm text-gray-600">{proposta.cidade}</td>
                                                                <td className="px-4 py-3 text-sm text-gray-600">{proposta.telefone}</td>
                                                                <td className="px-4 py-3 text-sm text-gray-600">{proposta.tipo_pessoa === 'fisica' ? proposta.cpf : proposta.cnpj}</td>
                                                                <td className="px-4 py-3 text-sm font-bold text-green-700 bg-yellow-50">{proposta.vendedor || '-'}</td>
                                                                <td className="px-4 py-3 text-sm text-gray-600">{formatarData(proposta.data_criacao)}</td>
                                                                <td className="px-4 py-3">
                                                                    {getStatusBadge(proposta.status || 'pendente')}
                                                                </td>
                                                                <td className="px-4 py-3 flex gap-2">
                                                                    <button onClick={() => setPropostaAnexos(proposta)} className="px-3 py-1 bg-purple-600 text-white text-xs rounded hover:bg-purple-700">
                                                                        üëÅÔ∏è Anexos
                                                                    </button>
                                                                    <button onClick={() => handleEditClick(proposta)} className="px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">
                                                                        üìù Editar
                                                                    </button>
                                                                    {(!proposta.numero_contrato || proposta.numero_contrato === '-') ? (
                                                                        <button onClick={() => gerarNumeroContrato(proposta)} className="px-3 py-1 bg-orange-600 text-white text-xs rounded hover:bg-orange-700">
                                                                            üî¢ Gerar N¬∫
                                                                        </button>
                                                                    ) : (
                                                                        <button onClick={() => gerarEBaixarContrato(proposta)} className="px-3 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700">
                                                                            üìÑ Contrato
                                                                        </button>
                                                                    )}
                                                                </td>
                                                            </tr>
                                                        );
                                                    })
                                                )}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </>
                        )}
                    </div>

                    {selectedProposta && (
                        <EditPropostaModal 
                            proposta={selectedProposta} 
                            onClose={() => setSelectedProposta(null)} 
                            onSave={handleSaveEdit}
                            saving={savingProposta}
                        />
                    )}

                    {propostaAnexos && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
                                <div className="p-6 border-b border-gray-200">
                                    <h2 className="text-2xl font-bold text-gray-800">üìé Anexos da Proposta</h2>
                                    <p className="text-sm text-gray-500">Cliente: {propostaAnexos.nome && propostaAnexos.sobrenome 
                                        ? `${propostaAnexos.nome} ${propostaAnexos.sobrenome}`
                                        : propostaAnexos.nome_fantasia || 'Sem nome'}</p>
                                    <p className="text-sm text-blue-600">N¬∫ Contrato: {propostaAnexos.numero_contrato || 'N/A'}</p>
                                </div>
                                <div className="p-6 overflow-y-auto">
                                    <div className="space-y-4">
                                        <div className={`flex items-center justify-between p-4 rounded-lg border ${propostaAnexos.arquivo_conta_url ? 'bg-blue-50 border-blue-200' : 'bg-gray-50 border-gray-200 opacity-60'}`}>
                                            <div>
                                                <p className={`font-semibold ${propostaAnexos.arquivo_conta_url ? 'text-blue-800' : 'text-gray-500'}`}>‚ö° Conta de Energia</p>
                                                {!propostaAnexos.arquivo_conta_url && <p className="text-sm text-gray-400">N√£o enviado</p>}
                                            </div>
                                            <div className="flex gap-2">
                                                {propostaAnexos.arquivo_conta_url && (
                                                    <a href={propostaAnexos.arquivo_conta_url} target="_blank" rel="noopener noreferrer" className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm font-semibold">
                                                        üëÅÔ∏è Ver
                                                    </a>
                                                )}
                                                <button 
                                                    onClick={() => document.getElementById('upload-conta').click()} 
                                                    className="px-4 py-2 bg-orange-600 text-white rounded hover:bg-orange-700 text-sm font-semibold"
                                                >
                                                    üì§ {propostaAnexos.arquivo_conta_url ? 'Substituir' : 'Enviar'}
                                                </button>
                                                <input 
                                                    id="upload-conta" 
                                                    type="file" 
                                                    accept="image/*,application/pdf" 
                                                    className="hidden" 
                                                    onChange={(e) => handleSubstituirAnexo(e, propostaAnexos.id, 'arquivo_conta_url', 'conta')}
                                                />
                                            </div>
                                        </div>
                                        
                                        <div className={`flex items-center justify-between p-4 rounded-lg border ${propostaAnexos.rg_frente_url ? 'bg-green-50 border-green-200' : 'bg-gray-50 border-gray-200 opacity-60'}`}>
                                            <div>
                                                <p className={`font-semibold ${propostaAnexos.rg_frente_url ? 'text-green-800' : 'text-gray-500'}`}>ü™™ RG/CNH (Frente)</p>
                                                {!propostaAnexos.rg_frente_url && <p className="text-sm text-gray-400">N√£o enviado</p>}
                                            </div>
                                            <div className="flex gap-2">
                                                {propostaAnexos.rg_frente_url && (
                                                    <a href={propostaAnexos.rg_frente_url} target="_blank" rel="noopener noreferrer" className="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 text-sm font-semibold">
                                                        üëÅÔ∏è Ver
                                                    </a>
                                                )}
                                                <button 
                                                    onClick={() => document.getElementById('upload-rg-frente').click()} 
                                                    className="px-4 py-2 bg-orange-600 text-white rounded hover:bg-orange-700 text-sm font-semibold"
                                                >
                                                    üì§ {propostaAnexos.rg_frente_url ? 'Substituir' : 'Enviar'}
                                                </button>
                                                <input 
                                                    id="upload-rg-frente" 
                                                    type="file" 
                                                    accept="image/*,application/pdf" 
                                                    className="hidden" 
                                                    onChange={(e) => handleSubstituirAnexo(e, propostaAnexos.id, 'rg_frente_url', 'rg_frente')}
                                                />
                                            </div>
                                        </div>
                                        
                                        <div className={`flex items-center justify-between p-4 rounded-lg border ${propostaAnexos.rg_verso_url ? 'bg-green-50 border-green-200' : 'bg-gray-50 border-gray-200 opacity-60'}`}>
                                            <div>
                                                <p className={`font-semibold ${propostaAnexos.rg_verso_url ? 'text-green-800' : 'text-gray-500'}`}>ü™™ RG/CNH (Verso)</p>
                                                {!propostaAnexos.rg_verso_url && <p className="text-sm text-gray-400">N√£o enviado</p>}
                                            </div>
                                            <div className="flex gap-2">
                                                {propostaAnexos.rg_verso_url && (
                                                    <a href={propostaAnexos.rg_verso_url} target="_blank" rel="noopener noreferrer" className="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 text-sm font-semibold">
                                                        üëÅÔ∏è Ver
                                                    </a>
                                                )}
                                                <button 
                                                    onClick={() => document.getElementById('upload-rg-verso').click()} 
                                                    className="px-4 py-2 bg-orange-600 text-white rounded hover:bg-orange-700 text-sm font-semibold"
                                                >
                                                    üì§ {propostaAnexos.rg_verso_url ? 'Substituir' : 'Enviar'}
                                                </button>
                                                <input 
                                                    id="upload-rg-verso" 
                                                    type="file" 
                                                    accept="image/*,application/pdf" 
                                                    className="hidden" 
                                                    onChange={(e) => handleSubstituirAnexo(e, propostaAnexos.id, 'rg_verso_url', 'rg_verso')}
                                                />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div className="p-6 border-t border-gray-200 flex justify-end">
                                    <button onClick={() => setPropostaAnexos(null)} className="px-6 py-3 bg-gray-600 text-white rounded-lg font-semibold hover:bg-gray-700">
                                        Fechar
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<AdminPanel />, document.getElementById('root'));
    </script>
</body>
</html>